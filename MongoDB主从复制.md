
主从复制是MongoDB最常用的复制方式,也是一个简单的数据库同步备份的集群技术,这种方式很灵活.可用于备份,故障恢复,读扩展等. 
最基本的设置方式就是建立一个主节点和一个或多个从节点,每个从节点要知道主节点的地址. 


注意：

- 在数据库集群中要明确的知道谁是主服务器,主服务器只有一台.
- 从服务器要知道自己的数据源也就是对应的主服务是谁.
- –master用来确定主服务器,–slave 和 –source 来控制从服务器



### 数据库

```
192.168.106.132 主数据库
192.168.106.142 从数据库
```

### 配置

新建配置文件

在主数据库中新建配置文件master.conf(名字可以随便写),输入以下内容

```
dbpath=/var/data/db/
port = 27017
bind_ip = 127.0.0.1,192.168.106.132
master = true
```

>dbpath为MongoDB数据库路径
>PORT为端口
>bind_ip为现在访问的ip，这里只允许本机访问
>master=true 是指定这个为主数据库

从服务器上面的配置类似，新建文件slave.conf
```
dbpath = /var/data/db
port = 27017
source = 192.168.106.132:27017
slave = true
```
>slave=true是指定从数据库的意思

然后启动mongodb

```
主数据库上
mongod --config master.conf

从数据库上
mongod --config slave.conf
```
这样就可以了，可以在主数据库上添加数据，然后从服务器也会同步数据过来了。

>默认从数据库上是不允许进行读写操作的，所以会看不到，可以通过`rs.slaveOk()`解决

### 主从复制的原理–oplog

在主从结构中，主节点的操作记录成为oplog（operation log）。oplog存储在一个系统数据库local的集合oplog.$main中，这个集合的每个文档都代表主节点上执行的一个操作。 
从服务器会定期从主服务器中获取oplog记录，然后在本机上执行！对于存储oplog的集合，MongoDB采用的是固定集合，也就是说随着操作过多，新的操作会覆盖旧的操作！

### 主从复制的其他设置项

- –only 从节点指定复制某个数据库,默认是复制全部数据库 
- –slavedelay 从节点设置主数据库同步数据的延迟(单位是秒) 
- –fastsync 从节点以主数据库的节点快照为节点启动从数据库 
- –autoresync 从节点如果不同步则从新同步数据库(即选择当通过热添加了一台从服务器之后，从服务器选择是否更新主服务器之间的数据) 
- –oplogSize 主节点设置oplog的大小(主节点操作记录存储到local的oplog中)


### 添加或删除从节点

从数据库中进入local数据库，然后可以查看到有个`sources`的集合，然后可以查看到主服务器的信息。

![sources](http://ovv4v0gcw.bkt.clouddn.com/mongodbms01.png)

可以在这里修改节点

挂载到哪个主节点
```
db.sources.insert({“host”:”127.0.0.1:1111”})
```

删除被挂载的主节点
```
db.sources.remove({“host”:”127.0.0.1:1111”}) 
```

>主从备份中，主服务器是可以增加用户的，但是从服务器上不允许增加用户.


